## 第七章 测试

### 测试类型
原则：微服务使用自动化测试。

测试象限：


                    *业务
              验收测试、探索性测试
    *支持                            *评价
              单元测试、非功能测试
                    *技术
    
    更多参看《敏捷软件测试》  Lisa Crispin，Janet Gregory

### 测试范围

测试金字塔：
    
     范围更大，反馈周期长，问题定位麻烦
            ↑  
         *******
        *********
       *|界面测试|*
      **|服务测试|**  
     ***|单元测试|*** 
            ↓                             
    范围小，快速，隔离的更好，反对周期短，定位问题容易，但无法保证整体功能可用    
             
    更多参看Mike Cohn 的《Scrum敏捷软件开发》中介绍的金字塔

1. 单元测试：
    * 测试对象是函数或者方法
    * 测试之间彼此独立。
    * 不用启动服务，运行速度很快。
    * 快速反馈，常用于重构
    
2. 服务测试：测试对象是
    * 测试对象是微服务：
    * 服务的外界依赖需要打桩
    * 覆盖范围广
    * 测试时间长
    * 出现问题不好定位
        
3. 界面测试（端到端测试）
    * 测试对象：前端和后端
    * 需要打开浏览器

4. 权衡
5. 比例
    * 底层通常比上层多一个数量级。
    * 测试甜筒（倒金字塔）是一种反模式，丢弃单元测试，只保留大范围的测试。测试缓慢，反馈周期长，无法与持续构建有效集成，而较长时间的构建意味着很长时间才能发现问题。

### 7.3 测试

1. Mock和打桩都是测试替身，Mock比打桩更严格，例如对请求本身的验证（是否被正确调用，是否有权限）
2. Mounte Bank(http://www.mbtest.org)是一个智能打桩工具。服务测试的对=对象服务 + Mounte Bank实例

更多参看《测试驱动的面向软件开发》 弗里曼、普雷斯

### 7.4 使用扇入模型

P2P测试遇到的问题
1. 依赖其他服务的版本是什么？
2. 多个服务都需要P2P测试，有很多重叠，怎么办？

解决办法：将多个服务扇入到一个独立的P2P测试stage，任意服务发生变化都会运行这些测试。

### 7.5 端到端测试的缺点

### 7.6 避免异常正常化

服务数量越多，测试越脆弱，在人们对错误习以为常之前，必须找到这些脆弱的测试并消除他们。

1. 原则：服务开发者应保证测试套件健康，避免垃圾测试用例大爆发
2. 原则：优化测试周期，避免开发人员切换大脑上下文去修改bug。

    * 并行测试：使用Selenium Grid工具
    * 删除不必要的测试
    
3. 原则：减小部署周期，相应的测试周期得以缩减。周期越长，风险越大。
4. 原则：避免元版本。元版本：所有微服务使用一个版本号，意味着所有的微服务需要一同部署。

### 7.7 原则：测试场景，而不是测试故事

故事中包含加了太多重复的场景，造成反馈周期增加，重叠测试增多。

### 7.8 消费者驱动的契约 CDC(Consumer-Driven Contract)

CDC内容：将P2P测试转化为测试代码，
原则：尽量使用CDC
    
     范围更大，更有信心，反馈周期长，问题定位麻烦
     
                ↑  
         ****        ***
        *****        ****
       *|    界面测试    |*
      **|服务测试和CDC测试|**
     ***|    单元测试    |*** 
                ↓                             
    范围小，快速，隔离的更好，反对周期短，定位问题容易，但无法保证整体功能可用    
             

1. Pact是一个CDC工具，其使用过程

    1. 使用Ruby DSL定义期望
    2. 启动mock运行期望生成Pact规范文件
    3. 将Pact规范文件加入Git
    4. Pact Helper 取得规范文件
    5. 调用生产者

2. 原则：充分沟通，CDC

### 7.9 原则：减少P2P测试

### 7.10 先部署，再测试

原则：升级系统应该是平滑的。

1. 冒烟测试（也叫健康测试）

    使用蓝绿部署：将新版服务与生产环境部署，分离一部分生产环境流量到这个新版本，测试通过后将所有流量导入这个新版服务。

2. 金丝雀发布

    复制生产环境作为基线环境，新版服务部署为金丝雀，这两个部署与生产环境平行，然后将生产环境中的流量切换一部分到这两个环境，比较两个环境评估新服务是否达到标准，如果达到了标准，就可以将所有流量切换到新服务。

3. 权衡

MTBF(Mean time between failure) 平均失败间隔，指的是服务出现问题的间隔时间。

MTTR(Mean time to repair) 平均修复时间，指的是服务出现问题后，恢复服务所用的时间。

* MTBF 与 MTTR之间，在服务领域，MTTR胜出
* 快速发布 与 软件质量之间，在服务领域，快速发布胜出

### 小结

1. 优化快速反馈，使用不同类型的测试
1. 减少端到端测试，取而代之的是CDC
1. 使用CDC，提供沟通要点
2. 理解MTBF 与 MTTR 权衡关系