## 第八章 监控

### 8.1 监控

监控对象：

1. 主机：CPU，内存，工具：Nagios，托管服务 New Relic
2. 服务器日志：使用工具logrotate可以移除旧日志
3. 应用程序（微服务）：响应时间，错误次数

### 8.2 单一服务，多主机

关注点：

1. 数据聚合，查看多台主机整体状态
2. 单一主机：查看单一主机的问题
3. 日志：查看多台主机的日志，可以使用工具ssh-multiplexes

对于1和2可以使用Nagios工具

### 8.3 多个服务，多个服务器

监控方案：从日志到应用程序指标，收集和聚合尽可能多的数据。

### 8.4 日志

使用logstash收集日志，使用Kibana查看日志。

### 8.5 系统指标跟踪

Graphite：一个收集指标的系统。

收集指标的用处：方便做容量规划。

### 8.6 服务指标

收集服务指标的目的：

1. 了解功能的使用情况
2. 有助于改进系统
3. 冗余数据以备不时之需

### 8.7 综合监控

如何判断系统是否在正常工作？

语义监控：模拟真正的事件，根据事件的结果判断系统是否处于正常状态。

实现方式：基于端到端可以方便实现。

### 8.8 关联标识

在分布式系统中，特别是基于事件的系统中，一个请求进入系统后会被分发到更多的子系统中，通过关联标识可以跟踪这样的请求。例如一个标识号abc-123的请求会带着这个标识号进入到具体的微服务当中。

Zipkin是一个跟踪链路的工具。

关联标识在系统建立初期应该标准化。

例如：在HTTP客户端中加装标识。

JWT的token可以用作标识。

### 8.9 级联

如何监控服务之间的联系。Hystrix。

### 8.9 标准化

梳理需要标准化的内容：
* 日志格式
* 指标量存储方式
* 服务名称
* 扩容的主机标准

### 8.11 考虑受众

* 他们现在需要什么
* 他们之后需要什么
* 他们如何使用数据

更多参看《Information Dashboard Design: Displaying Data for Ata-Glance Monitoring》

### 8.12 未来

统一化业务指标和系统指标。

工具：Riemann + Suro  → Storm/Hadoop/Kibana

### 小结

作者的建议：

对服务而言：

* 至少跟踪响应时间。然后跟踪错误率和应用程序级别的指标。
* 至少跟踪下游服务的健康，包括下游调用的响应时间，错误率。使用类似Hystrix的工具。
* 制定标准化：如何收集指标以及存储指标。
* 统一日志标准格式格式，将日志记录到一个标准位置。
* 监控底层操作系统，以便于跟踪流氓进程和容量规划。

对系统而言：

* 聚合CPU之类的主机层级的指标和应用程序级别的指标。
* 确保指标存储工具可以在系统和服务级别做聚合，同时也允许查看单台主机的情况，可以使用Nagios这样的工具。
* 确保指标存储工具允许你维护数据足够长的时间，以了解你的系统的趋势
* 使用单个可查询工具对日志进行聚合和存储
* 强烈考虑标准化关联标识的使用
* 了解最应该关注的内容是什么，并根据这些内容构造相应的警报和仪表盘
* 调查对各种指标聚合方式做统一化的可能性，像Suro或Riemann这样的工具可能会对你有用
 